<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Huhtamaki Fiber Schicht Generator</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --border:#e2e8f0; --btn:#2563eb; --btnText:#fff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{max-width:980px; margin:48px auto; padding:0 16px;}
    h1{margin:0 0 18px; font-size:clamp(28px,4vw,46px); line-height:1.05; letter-spacing:-.02em; text-align:center;}
    .sub{margin:0 0 22px; text-align:center; color:var(--muted); font-size:14px}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px;
      padding:22px; box-shadow:0 10px 25px rgba(15,23,42,.06);
    }
    .grid{display:grid; gap:16px;}
    @media(min-width:720px){
      .grid{grid-template-columns:1fr 1fr;}
      .grid .full{grid-column:1 / -1;}
    }
    label{display:block; font-weight:700; margin-bottom:8px}
    select{
      width:100%; padding:12px 12px; border:1px solid var(--border); border-radius:10px;
      font-size:16px; background:#fff;
    }
    .hint{margin-top:8px; color:var(--muted); font-size:13px}
    .btnrow{display:grid; gap:10px; margin-top:16px;}
    @media(min-width:720px){ .btnrow{grid-template-columns:1fr 1fr 1fr;} }
    button{
      border:0; border-radius:12px; padding:12px 14px; font-size:16px; cursor:pointer;
      background:#eef2ff; color:#1e293b;
    }
    button.primary{background:var(--btn); color:var(--btnText); font-weight:700;}
    button:disabled{opacity:.45; cursor:not-allowed}
    .err{margin-top:14px; color:#b91c1c; font-weight:700}
    .ok{margin-top:14px; color:#065f46; font-weight:700}
    .links{margin-top:14px; padding:12px; border:1px dashed var(--border); border-radius:12px; display:none}
    .links a{word-break:break-all}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Huhtamaki Fiber Schicht Generator</h1>
    <p class="sub">PC & Smartphone – von Johannes Trippen</p>

    <div class="card">
      <div class="grid">
        <div>
          <label for="fiber">Abteilung</label>
          <select id="fiber">
            <option value="" selected disabled>Bitte wählen…</option>
            <option value="1">Fiber 1</option>
            <option value="2">Fiber 2</option>
          </select>
        </div>

        <div>
          <label for="team">Schicht</label>
          <select id="team" disabled>
            <option value="" selected disabled>Bitte zuerst Abteilung wählen…</option>
          </select>
        </div>

        <div class="full">
          <label for="year">Jahr</label>
          <select id="year"></select>
          <div class="hint" id="rangeHint"></div>
        </div>
      </div>

      <div class="btnrow">
        <button class="primary" id="btnGenerate" disabled>Generieren</button>
        <button id="btnPrintV1" disabled>Druck Monat untereinander</button>
        <button id="btnPrintV2" disabled>Druck Monat nebeneinander</button>
      </div>

      <div class="links" id="linksBox">
        <div><strong>ICS (Download):</strong> <a id="icsLink" href="#" target="_blank" rel="noopener"></a></div>
      </div>

      <div class="err" id="errBox" style="display:none"></div>
    </div>
  </div>

<script>
(() => {
  // ====== Konfiguration (muss zum Server passen) ======
  const SERVER_MIN_YEAR = 2026;
  const SERVER_MAX_YEAR = 2030;

  // UI-Wunsch: aktuelles Jahr + maximal 4 Jahre, aber NICHT über SERVER_MAX_YEAR
  const now = new Date();
  const currentYear = now.getFullYear();
  const uiMinYear = Math.max(SERVER_MIN_YEAR, currentYear);           // ab aktuellem Jahr
  const uiMaxYear = Math.min(SERVER_MAX_YEAR, currentYear + 4);       // bis max +4 / Serverlimit

  const fiberEl = document.getElementById('fiber');
  const teamEl  = document.getElementById('team');
  const yearEl  = document.getElementById('year');

  const btnGenerate = document.getElementById('btnGenerate');
  const btnPrintV1  = document.getElementById('btnPrintV1');
  const btnPrintV2  = document.getElementById('btnPrintV2');

  const errBox   = document.getElementById('errBox');
  const rangeHint = document.getElementById('rangeHint');

  const linksBox = document.getElementById('linksBox');
  const icsLink  = document.getElementById('icsLink');

  // Teams (Schichten) pro Abteilung
  // Werte sind absichtlich NUMERISCH, weil die URLs bei dir so aussehen: ?fiber=2&team=2&year=2026
  const TEAM_OPTIONS = [
    { value: "1", label: "P1" },
    { value: "2", label: "P2" },
    { value: "3", label: "P3" },
    { value: "4", label: "P4" },
  ];

  function setError(msg){
    errBox.textContent = msg;
    errBox.style.display = msg ? 'block' : 'none';
  }

  function fillYears(){
    yearEl.innerHTML = '';
    for(let y = uiMinYear; y <= uiMaxYear; y++){
      const opt = document.createElement('option');
      opt.value = String(y);
      opt.textContent = String(y);
      yearEl.appendChild(opt);
    }
    // wenn UI-Min > UI-Max (z.B. nach 2030), trotzdem etwas anzeigen:
    if(uiMinYear > uiMaxYear){
      const opt = document.createElement('option');
      opt.value = String(SERVER_MAX_YEAR);
      opt.textContent = String(SERVER_MAX_YEAR);
      yearEl.appendChild(opt);
    }
    rangeHint.textContent = `Erlaubt: ${uiMinYear} bis ${uiMaxYear} (Server: ${SERVER_MIN_YEAR} bis ${SERVER_MAX_YEAR})`;
  }

  function fillTeams(){
    teamEl.innerHTML = '';
    const ph = document.createElement('option');
    ph.value = '';
    ph.disabled = true;
    ph.selected = true;
    ph.textContent = 'Bitte wählen…';
    teamEl.appendChild(ph);

    TEAM_OPTIONS.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.value;
      opt.textContent = t.label;
      teamEl.appendChild(opt);
    });

    teamEl.disabled = false;
  }

  function updateButtons(){
    const ok = fiberEl.value && teamEl.value && yearEl.value;
    btnGenerate.disabled = !ok;
    btnPrintV1.disabled  = !ok;
    btnPrintV2.disabled  = !ok;
  }

  function buildQuery(){
    const fiber = fiberEl.value;
    const team  = teamEl.value;
    const year  = yearEl.value;

    // harte Sicherung gegen falsche Jahre (damit der Server nicht meckert)
    const y = parseInt(year, 10);
    if(!(y >= SERVER_MIN_YEAR && y <= SERVER_MAX_YEAR)){
      throw new Error(`year muss ${SERVER_MIN_YEAR} bis ${SERVER_MAX_YEAR} sein`);
    }
    return { fiber, team, year };
  }

  function openPrint(v){
    setError('');
    linksBox.style.display = 'none';

    let q;
    try{ q = buildQuery(); } catch(e){ setError('Fehler: ' + e.message); return; }

    const url = `/printv${v}?fiber=${encodeURIComponent(q.fiber)}&team=${encodeURIComponent(q.team)}&year=${encodeURIComponent(q.year)}`;
    window.open(url, '_blank', 'noopener');
  }

  function openICS(){
    setError('');
    let q;
    try{ q = buildQuery(); } catch(e){ setError('Fehler: ' + e.message); return; }

    const url = `/ics?fiber=${encodeURIComponent(q.fiber)}&team=${encodeURIComponent(q.team)}&year=${encodeURIComponent(q.year)}`;
    icsLink.href = url;
    icsLink.textContent = url;
    linksBox.style.display = 'block';
    window.open(url, '_blank', 'noopener');
  }

  // Init
  fillYears();
  updateButtons();

  // Startzustand: nichts ausgewählt (wie gewünscht)
  fiberEl.value = '';
  teamEl.value = '';
  teamEl.disabled = true;

  fiberEl.addEventListener('change', () => {
    setError('');
    linksBox.style.display = 'none';
    // Team reset + neu befüllen
    fillTeams();
    teamEl.value = '';
    updateButtons();
  });

  teamEl.addEventListener('change', updateButtons);
  yearEl.addEventListener('change', () => { setError(''); updateButtons(); });

  btnGenerate.addEventListener('click', openICS);
  btnPrintV1.addEventListener('click', () => openPrint(1));
  btnPrintV2.addEventListener('click', () => openPrint(2));
})();
</script>
</body>
</html>
