<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Schichtkalender (ICS) ‚Äì Web Generator</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#fff;color:#111}
    .wrap{max-width:920px;margin:40px auto;padding:0 16px}
    h1{font-size:40px;margin:0 0 18px;text-align:center}
    .card{border:1px solid #ddd;border-radius:14px;padding:18px 18px 14px}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .field{flex:1;min-width:220px}
    label{display:block;font-weight:700;margin:6px 0}
    select,input{width:100%;padding:10px 12px;border:1px solid #ccc;border-radius:10px;font-size:16px}
    button{width:100%;padding:14px 16px;border:0;border-radius:10px;font-size:18px;font-weight:800;cursor:pointer}
    .btn{background:#0b5fff;color:#fff;margin-top:14px}
    .btn4{background:#444;color:#fff;margin-top:10px}
    .error{color:#b00020;font-weight:800;margin-top:10px;display:none}
    .out{margin-top:14px;border-top:1px solid #eee;padding-top:14px;display:none}
    .links{ text-align:center }
    .links a{display:inline-block;margin:0 10px}
    .qrgrid{display:flex;gap:18px;flex-wrap:wrap;margin-top:12px;justify-content:center}
    .qrbox{border:1px solid #ddd;border-radius:12px;padding:10px;text-align:center;min-width:260px}
    .qrbox img{width:220px;height:220px;object-fit:contain;border:1px solid #eee;border-radius:10px}
    .hint{margin-top:8px;color:#666;font-size:13px;text-align:center}
    .topline{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
    .topline button{width:auto;min-width:260px}
    code{background:#f2f2ff;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Schichtkalender (ICS) ‚Äì Web Generator</h1>

    <div class="card">
      <div class="row">
        <div class="field">
          <label for="fiber">Fiber</label>
          <select id="fiber">
            <option value="1">Fiber 1</option>
            <option value="2" selected>Fiber 2</option>
          </select>
        </div>

        <div class="field">
          <label for="team">Team</label>
          <select id="team">
            <option value="1" selected>Team 1 (P1)</option>
            <option value="2">Team 2 (P2)</option>
            <option value="3">Team 3 (P3)</option>
            <option value="4">Team 4 (P4)</option>
          </select>
        </div>

        <div class="field">
          <label for="year">Jahr</label>
          <input id="year" type="number" inputmode="numeric" />
          <div class="hint" id="yearHint"></div>
        </div>
      </div>

      <button class="btn" id="btnGenerate">Generieren (ICS + QR)</button>

      <div class="topline">
        <button class="btn4" id="btnPrintV1">üñ® Drucken V1 (PDF) ‚Äì wie Excel V1</button>
        <button class="btn4" id="btnPrintV2">üñ® Drucken V2 (PDF) ‚Äì wie Excel V2</button>
      </div>

      <div id="msg" class="error"></div>

      <div class="out" id="out">
        <div class="links">
          <a id="linkIcs" href="#" target="_blank" rel="noopener">ICS √∂ffnen / downloaden</a>
          <a id="linkWebcal" href="#" target="_blank" rel="noopener">iOS webcal abonnieren</a>
        </div>

        <div class="qrgrid">
          <div class="qrbox">
            <div style="font-weight:900;margin-bottom:6px">QR iOS (webcal Abo)</div>
            <img id="qrIos" alt="QR iOS" />
            <div class="hint"><code id="txtIos"></code></div>
          </div>

          <div class="qrbox">
            <div style="font-weight:900;margin-bottom:6px">QR Android (ICS Download)</div>
            <img id="qrIcs" alt="QR ICS" />
            <div class="hint"><code id="txtIcs"></code></div>
          </div>
        </div>

        <div class="hint" id="qrWarn" style="display:none;color:#b00020;font-weight:800">
          QR wurde blockiert (Adblock/Schutz). Du kannst trotzdem die Links oben nutzen.
        </div>
      </div>

      <div class="hint">
        Tipp: Beim Drucken im Browser ‚ÄûAls PDF speichern‚Äú w√§hlen.
      </div>
    </div>
  </div>

<script>
/* ========= Jahr-Limits wie bei dir ========= */
const MIN_YEAR = 2026;
const MAX_YEAR = new Date().getFullYear() + 4;

const yearInput = document.getElementById("year");
const yearHint = document.getElementById("yearHint");
yearInput.min = String(MIN_YEAR);
yearInput.max = String(MAX_YEAR);
yearInput.value = String(Math.max(MIN_YEAR, Math.min(new Date().getFullYear(), MAX_YEAR)));
yearHint.textContent = `Erlaubt: ${MIN_YEAR} bis ${MAX_YEAR}`;

/* ========= UI helpers ========= */
const msg = document.getElementById("msg");
function showError(t){ msg.style.display="block"; msg.textContent=t; }
function hideError(){ msg.style.display="none"; msg.textContent=""; }

function getParams() {
  const fiber = document.getElementById("fiber").value;
  const team = document.getElementById("team").value;
  const year = Number(document.getElementById("year").value);
  if (!Number.isFinite(year)) throw new Error("Bitte ein g√ºltiges Jahr eingeben.");
  if (year < MIN_YEAR || year > MAX_YEAR) throw new Error(`Fehler: year muss ${MIN_YEAR} bis ${MAX_YEAR} sein`);
  return { fiber, team, year };
}

/* ========= Rhythmen (1:1 aus VBA) ========= */
function getRhythm(fiber, team) {
  if (fiber === "2") {
    switch (team) {
      case "1": return ["Fr√ºh","Sp√§t","Sp√§t","Nacht","Nacht","Nacht","Frei","Frei","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Sp√§t","Nacht","Nacht","Frei","Frei","Fr√ºh","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Nacht","Nacht","Frei","Frei","Frei","Fr√ºh"];
      case "2": return ["Sp√§t","Nacht","Nacht","Frei","Frei","Frei","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Nacht","Nacht","Nacht","Frei","Frei","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Sp√§t","Nacht","Nacht","Frei","Frei","Fr√ºh","Fr√ºh","Fr√ºh","Sp√§t"];
      case "3": return ["Nacht","Frei","Frei","Fr√ºh","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Nacht","Nacht","Frei","Frei","Frei","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Nacht","Nacht","Nacht","Frei","Frei","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Sp√§t","Nacht"];
      case "4": return ["Frei","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Sp√§t","Nacht","Nacht","Frei","Frei","Fr√ºh","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Nacht","Nacht","Frei","Frei","Frei","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Nacht","Nacht","Nacht","Frei"];
    }
  } else {
    switch (team) {
      case "1": return ["Sp√§t","Nacht","Nacht","Nacht","Frei","Frei","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Sp√§t","Nacht","Nacht","Frei","Frei","Fr√ºh","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Nacht","Nacht","Frei","Frei","Frei","Fr√ºh","Fr√ºh","Sp√§t"];
      case "2": return ["Nacht","Frei","Frei","Frei","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Nacht","Nacht","Nacht","Frei","Frei","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Sp√§t","Nacht","Nacht","Frei","Frei","Fr√ºh","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Nacht"];
      case "3": return ["Frei","Fr√ºh","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Nacht","Nacht","Frei","Frei","Frei","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Nacht","Nacht","Nacht","Frei","Frei","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Sp√§t","Nacht","Nacht","Frei"];
      case "4": return ["Fr√ºh","Sp√§t","Sp√§t","Sp√§t","Nacht","Nacht","Frei","Frei","Fr√ºh","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Nacht","Nacht","Frei","Frei","Frei","Fr√ºh","Fr√ºh","Sp√§t","Sp√§t","Nacht","Nacht","Nacht","Frei","Frei","Fr√ºh"];
    }
  }
  return null;
}

function buildYearPlan(fiber, team, year) {
  const rhythm = getRhythm(fiber, team);
  if (!rhythm) return [];

  const ref = new Date(Date.UTC(2026,0,1)); // wie VBA
  const start = new Date(Date.UTC(year,0,1));
  const end = new Date(Date.UTC(year,11,31));

  const daysDiff = Math.round((start - ref) / 86400000);
  let pos = ((0 + daysDiff) % 28 + 28) % 28;

  const out = [];
  for (let d = new Date(start); d <= end; d = new Date(d.getTime() + 86400000)) {
    const sc = rhythm[pos % 28];
    out.push({ date: new Date(d), shift: sc });
    pos++;
  }
  return out;
}

function shiftLetter(shift) {
  const s = (shift || "").toLowerCase();
  if (s === "fr√ºh") return "F";
  if (s === "sp√§t") return "S";
  if (s === "nacht") return "N";
  return "";
}

/* ========= Feiertage (1:1 Osterdatum Gau√ü) ========= */
function easterDate(year){
  const a = year % 19;
  const b = Math.floor(year / 100);
  const c = year % 100;
  const d = Math.floor(b / 4);
  const e = b % 4;
  const f = Math.floor((b + 8) / 25);
  const g = Math.floor((b - f + 1) / 3);
  const h = (19 * a + b - d - g + 15) % 30;
  const i = Math.floor(c / 4);
  const k = c % 4;
  const L = (32 + 2 * e + 2 * i - h - k) % 7;
  const m = Math.floor((a + 11 * h + 22 * L) / 451);
  const month = Math.floor((h + L - 7 * m + 114) / 31);
  const day = ((h + L - 7 * m + 114) % 31) + 1;
  return new Date(Date.UTC(year, month - 1, day));
}

function isoUTC(dt){ return dt.toISOString().slice(0,10); }

function buildHolidaySet(year){
  const set = new Set();
  const ost = easterDate(year);

  // feste
  set.add(isoUTC(new Date(Date.UTC(year,0,1))));
  set.add(isoUTC(new Date(Date.UTC(year,4,1))));
  set.add(isoUTC(new Date(Date.UTC(year,9,3))));
  set.add(isoUTC(new Date(Date.UTC(year,11,25))));
  set.add(isoUTC(new Date(Date.UTC(year,11,26))));

  // bewegliche
  set.add(isoUTC(new Date(ost.getTime() - 2*86400000)));   // Karfreitag
  set.add(isoUTC(new Date(ost.getTime() + 1*86400000)));   // Ostermontag
  set.add(isoUTC(new Date(ost.getTime() + 39*86400000)));  // Himmelfahrt
  set.add(isoUTC(new Date(ost.getTime() + 49*86400000)));  // Pfingstsonntag (wie VBA)
  set.add(isoUTC(new Date(ost.getTime() + 50*86400000)));  // Pfingstmontag
  set.add(isoUTC(new Date(ost.getTime() + 60*86400000)));  // Fronleichnam (RLP)

  return set;
}

/* ========= Ferien aus Function /vacations ========= */
async function loadVacationSet(year){
  try{
    const res = await fetch(`/vacations?year=${encodeURIComponent(year)}`);
    const data = await res.json();
    return new Set((data.dates || []));
  }catch{
    return new Set();
  }
}

/* ========= QR ========= */
const outBox = document.getElementById("out");
const linkIcs = document.getElementById("linkIcs");
const linkWebcal = document.getElementById("linkWebcal");
const qrIos = document.getElementById("qrIos");
const qrIcs = document.getElementById("qrIcs");
const txtIos = document.getElementById("txtIos");
const txtIcs = document.getElementById("txtIcs");
const qrWarn = document.getElementById("qrWarn");

function setQr(imgEl, text) {
  const qrApi = "https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=";
  imgEl.referrerPolicy = "no-referrer";
  imgEl.onerror = () => { qrWarn.style.display = "block"; };
  imgEl.src = qrApi + encodeURIComponent(text);
}

document.getElementById("btnGenerate").addEventListener("click", () => {
  try {
    hideError();
    qrWarn.style.display = "none";

    const { fiber, team, year } = getParams();

    const base = location.origin;
    const icsUrl = `${base}/ics?fiber=${fiber}&team=${team}&year=${year}`;
    const webcalUrl = `webcal://${location.host}/ics?fiber=${fiber}&team=${team}&year=${year}`;

    linkIcs.href = icsUrl;
    linkWebcal.href = webcalUrl;

    txtIos.textContent = webcalUrl;
    txtIcs.textContent = icsUrl;

    setQr(qrIos, webcalUrl);
    setQr(qrIcs, icsUrl);

    outBox.style.display = "block";
  } catch (e) {
    showError(e.message || String(e));
  }
});

/* ========= Drucken (mit Feiertag/Ferien Farben) ========= */
function openPrintWindow(html) {
  const w = window.open("", "_blank");
  if (!w) { alert("Popup blockiert. Bitte Popups erlauben."); return; }
  w.document.open();
  w.document.write(html);
  w.document.close();
  w.focus();
  setTimeout(() => w.print(), 350);
}

function cssPrintBase() {
  return `
    <style>
      @page { size: A4 landscape; margin: 10mm; }
      body{font-family:Arial,Helvetica,sans-serif;color:#111}
      h1{font-size:22px;margin:0 0 10px;text-align:center}
      .sub{font-size:12px;text-align:center;margin-bottom:10px;color:#444}
      table{border-collapse:collapse;width:100%}
      th,td{border:1px solid #000;padding:2px 3px;font-size:9px;text-align:center}
      th{background:#eee}
      .mcell{font-weight:900}
      .F{background:#ff0}
      .S{background:#f00;color:#000}
      .N{background:#00b0f0}
      .HOL{background:#ffc8c8}   /* Feiertag wie Excel */
      .VAC{background:#c8dcff}   /* Ferien wie Excel */
      .legend{margin-top:8px;display:flex;gap:10px;justify-content:center}
      .box{border:1px solid #000;padding:4px 8px;font-size:10px}
    </style>
  `;
}

function renderPrintV1(fiber, team, year, holidaySet, vacationSet) {
  const plan = buildYearPlan(fiber, team, year);
  const byMonth = Array.from({length:12}, () => ({}));
  for (const p of plan) {
    const m = p.date.getUTCMonth();
    const day = p.date.getUTCDate();
    byMonth[m][day] = shiftLetter(p.shift);
  }

  const monthNames = ["Januar","Februar","M√§rz","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"];
  let rows = "";

  for (let m=0; m<12; m++) {
    // Header-Zeile: Wochentag-Label nur als Text (wie Excel ist egal)
    rows += `<tr>
      <td class="mcell" rowspan="3">${monthNames[m]}</td>
      <td class="mcell">Wochentag</td>
      ${Array.from({length:31}, (_,i)=>`<td>${i+1}</td>`).join("")}
    </tr>`;

    // Tag-Zeile mit Ferien/Feiertag F√§rbung (wie Excel)
    rows += `<tr>
      <td class="mcell">Tag</td>
      ${Array.from({length:31}, (_,i)=>{
        const d = i+1;
        const dim = new Date(Date.UTC(year, m+1, 0)).getUTCDate();
        if (d>dim) return `<td></td>`;
        const iso = new Date(Date.UTC(year,m,d)).toISOString().slice(0,10);
        const cls = holidaySet.has(iso) ? "HOL" : (vacationSet.has(iso) ? "VAC" : "");
        return `<td class="${cls}">${d}</td>`;
      }).join("")}
    </tr>`;

    // Schicht-Zeile (F/S/N)
    rows += `<tr>
      <td class="mcell">Schicht</td>
      ${Array.from({length:31}, (_,i)=>{
        const d = i+1;
        const dim = new Date(Date.UTC(year, m+1, 0)).getUTCDate();
        if (d>dim) return `<td></td>`;
        const letter = byMonth[m][d] || "";
        const cls = letter ? letter : "";
        return `<td class="${cls}">${letter}</td>`;
      }).join("")}
    </tr>`;
  }

  return `
    <!doctype html><html><head><meta charset="utf-8">
    <title>Druck V1</title>
    ${cssPrintBase()}
    </head><body>
      <h1>Schichtplan ${year} ‚Äì Fiber ${fiber} ‚Äì Team P${team} (V1)</h1>
      <div class="sub">Printed by: Johannes Trippen¬©</div>

      <table>
        <thead>
          <tr>
            <th style="width:95px">Monat</th>
            <th style="width:70px">Info</th>
            ${Array.from({length:31}, (_,i)=>`<th>${i+1}</th>`).join("")}
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>

      <div class="legend">
        <div class="box HOL">Feiertag</div>
        <div class="box VAC">Ferien</div>
        <div class="box F">F = Fr√ºh</div>
        <div class="box S">S = Sp√§t</div>
        <div class="box N">N = Nacht</div>
      </div>
    </body></html>
  `;
}

function renderPrintV2(fiber, team, year, holidaySet, vacationSet) {
  const plan = buildYearPlan(fiber, team, year);
  const map = new Map();
  for (const p of plan) map.set(p.date.toISOString().slice(0,10), shiftLetter(p.shift));

  const monthNames = ["Jan","Feb","M√§r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];

  let head = "";
  for (let m=0;m<12;m++) head += `<th colspan="3">${monthNames[m]}</th>`;

  let body = "";
  for (let day=1; day<=31; day++){
    let tr = "<tr>";
    for (let m=0;m<12;m++){
      const dim = new Date(Date.UTC(year, m+1, 0)).getUTCDate();
      if (day > dim) {
        tr += `<td></td><td></td><td></td>`;
      } else {
        const iso = new Date(Date.UTC(year,m,day)).toISOString().slice(0,10);
        const letter = map.get(iso) || "";
        const clsShift = letter ? letter : "";
        const clsDay = holidaySet.has(iso) ? "HOL" : (vacationSet.has(iso) ? "VAC" : "");
        tr += `<td class="${clsDay}"></td><td class="${clsDay} mcell">${day}</td><td class="${clsShift}">${letter}</td>`;
      }
    }
    tr += "</tr>";
    body += tr;
  }

  return `
    <!doctype html><html><head><meta charset="utf-8">
    <title>Druck V2</title>
    ${cssPrintBase()}
    </head><body>
      <h1>Schichtplan ${year} ‚Äì Fiber ${fiber} ‚Äì Team P${team} (V2)</h1>
      <div class="sub">Printed by: Johannes Trippen¬©</div>

      <table>
        <thead>
          <tr>${head}</tr>
          <tr>
            ${Array.from({length:12},()=>`<th style="width:10px"></th><th style="width:18px">Tag</th><th style="width:22px">S</th>`).join("")}
          </tr>
        </thead>
        <tbody>${body}</tbody>
      </table>

      <div class="legend">
        <div class="box HOL">Feiertag</div>
        <div class="box VAC">Ferien</div>
        <div class="box F">F = Fr√ºh</div>
        <div class="box S">S = Sp√§t</div>
        <div class="box N">N = Nacht</div>
      </div>
    </body></html>
  `;
}

document.getElementById("btnPrintV1").addEventListener("click", async () => {
  try {
    hideError();
    const { fiber, team, year } = getParams();

    const holidaySet = buildHolidaySet(year);
    const vacationSet = await loadVacationSet(year);

    openPrintWindow(renderPrintV1(fiber, team, year, holidaySet, vacationSet));
  } catch (e) {
    showError(e.message || String(e));
  }
});

document.getElementById("btnPrintV2").addEventListener("click", async () => {
  try {
    hideError();
    const { fiber, team, year } = getParams();

    const holidaySet = buildHolidaySet(year);
    const vacationSet = await loadVacationSet(year);

    openPrintWindow(renderPrintV2(fiber, team, year, holidaySet, vacationSet));
  } catch (e) {
    showError(e.message || String(e));
  }
});
</script>
</body>
</html>
