<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Schichtkalender (ICS) – Web Generator</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <style>
    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --danger:#b91c1c;
      --card:#ffffff;
      --shadow:0 10px 30px rgba(0,0,0,.06);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:var(--bg);}
    .wrap{max-width:980px;margin:48px auto;padding:0 16px;}
    h1{font-size:42px;line-height:1.05;margin:0 0 22px;text-align:center;letter-spacing:-0.02em;}
    .subtitle{text-align:center;font-size:14px;color:var(--muted);margin-top:-12px;margin-bottom:22px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
    @media (max-width:820px){.grid{grid-template-columns:1fr}h1{font-size:34px}}
    label{display:block;font-weight:650;margin:0 0 8px;}
    select{width:100%;padding:12px 12px;border:1px solid var(--border);border-radius:10px;font-size:16px;outline:none;background:#fff;}
    select:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(59,130,246,.15)}
    .actions{margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;}
    button,a.btn{border:0;border-radius:12px;padding:12px 16px;font-weight:700;font-size:16px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px;user-select:none;}
    button.primary{background:var(--primary);color:#fff;}
    button.primary:hover{background:var(--primary2)}
    button.secondary{background:#f3f4f6;color:#111827;}
    button.secondary:hover{background:#e5e7eb}
    button:disabled{opacity:.55;cursor:not-allowed;}
    .hint{color:var(--muted);margin-top:10px;font-size:14px;}
    .err{margin-top:12px;color:var(--danger);font-weight:700;display:none;}
    .out{margin-top:18px;padding-top:18px;border-top:1px dashed var(--border);display:none;}
    .out h2{margin:0 0 10px;font-size:18px;}
    .links{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 0;}
    .links a{background:#f3f4f6;color:#111827;padding:10px 12px;border-radius:12px;text-decoration:none;border:1px solid #e5e7eb;font-weight:650;}
    .links a:hover{background:#e5e7eb}
    .qrgrid{margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    @media (max-width:820px){.qrgrid{grid-template-columns:1fr}}
    .qrbox{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;}
    .qrbox h3{margin:0 0 10px;font-size:15px;}
    .qrbox img{width:100%;max-width:220px;height:auto;display:block;margin:0 auto 10px;}
    .small{font-size:12px;color:var(--muted);word-break:break-all;}
  </style>
</head>

<body>
<div class="wrap">

<h1>Huhtamaki Fiber Schichtkalender</h1>
<div class="subtitle">PC & Smartphone von Johannes Trippen</div>

<div class="card">
  <!-- FORM -->
  <div class="grid">
    <div>
      <label for="fiber">Abteilung</label>
      <select id="fiber">
        <option value="" selected disabled>Bitte wählen…</option>
        <option value="1">Fiber 1</option>
        <option value="2">Fiber 2</option>
      </select>
    </div>

    <div>
      <label for="team">Team</label>
      <select id="team" disabled>
        <option value="" selected disabled>Bitte zuerst Abteilung wählen…</option>
      </select>
    </div>

    <div>
      <label for="year">Jahr</label>
      <select id="year">
        <option value="" selected disabled>Bitte wählen…</option>
      </select>
      <div class="hint" id="yearHint"></div>
    </div>
  </div>

  <div class="actions">
    <button id="btnGenerate" class="primary" disabled>Generieren</button>
    <button id="btnPrintV1" class="secondary" disabled>Jahresplan Monate untereinander</button>
    <button id="btnPrintV2" class="secondary" disabled>Jahresplan Monate nebeneinander</button>
  </div>

  <div class="err" id="err"></div>

  <div class="out" id="out">
    <h2>Downloads / Links</h2>
    <div class="links" id="links"></div>

    <div class="qrgrid" id="qrgrid">
      <div class="qrbox">
        <h3>iOS (Abo / webcal)</h3>
        <img id="qrIos" alt="QR iOS" />
        <div class="small" id="urlIos"></div>
      </div>
      <div class="qrbox">
        <h3>Android (RAW Download/Import)</h3>
        <img id="qrAndroid" alt="QR Android" />
        <div class="small" id="urlAndroid"></div>
      </div>
    </div>
  </div>
</div>

<div class="hint" style="text-align:center;margin-top:14px;">
  Tipp: iOS kann alle 3 Download´s importieren und QR-Codes Scannen. Android in der Regel den ICS direkt Download!
</div>

<!-- COUNTER (unauffällig) -->
<div id="genCounter" class="hint" style="text-align:center;font-size:12px;margin-top:6px;">
  Generierungen insgesamt: 0
</div>

</div>

<script>
(function(){

  /* ================= COUNTER (GLOBAL / SERVER) ================= */
  const COUNTER_KEY = 'huhtamaki_generator';

  function updateCounterView(value){
    const el = document.getElementById('genCounter');
    if(el && typeof value === 'number'){
      el.textContent = 'Generierungen insgesamt: ' + value;
    }
  }

  async function loadGlobalCounter(){
    try{
      const res = await fetch('/counter?mode=view&key=' + encodeURIComponent(COUNTER_KEY), { cache: 'no-store' });
      if(!res.ok) return;
      const data = await res.json();
      updateCounterView(data.value);
    }catch(e){}
  }

  async function incrementGlobalCounter(){
    try{
      const res = await fetch('/counter?mode=inc&key=' + encodeURIComponent(COUNTER_KEY), { cache: 'no-store' });
      if(!res.ok) return;
      const data = await res.json();
      updateCounterView(data.value);
    }catch(e){}
  }
/* ============================================================= */

  /* =========================================== */

  const MIN_YEAR = 2026;

  const fiberEl = document.getElementById('fiber');
  const teamEl  = document.getElementById('team');
  const yearEl  = document.getElementById('year');
  const yearHint= document.getElementById('yearHint');

  const btnGenerate = document.getElementById('btnGenerate');
  const btnPrintV1  = document.getElementById('btnPrintV1');
  const btnPrintV2  = document.getElementById('btnPrintV2');

  const errEl   = document.getElementById('err');
  const outEl   = document.getElementById('out');
  const linksEl = document.getElementById('links');

  const qrIosImg = document.getElementById('qrIos');
  const qrAndImg = document.getElementById('qrAndroid');
  const urlIosEl = document.getElementById('urlIos');
  const urlAndEl = document.getElementById('urlAndroid');

  const now = new Date();
  const currentYear = now.getFullYear();
  const startYear = Math.max(MIN_YEAR, currentYear);
  const endYear = currentYear + 4;
  const safeEndYear = Math.max(endYear, startYear);

  for(let y = startYear; y <= safeEndYear; y++){
    const opt = document.createElement('option');
    opt.value = String(y);
    opt.textContent = String(y);
    yearEl.appendChild(opt);
  }
  yearHint.textContent = `Erlaubt: ${startYear} bis ${safeEndYear}`;

  function setTeamOptionsForFiber(fiberVal){
    teamEl.innerHTML = '';
    const ph = document.createElement('option');
    ph.value = '';
    ph.disabled = true;
    ph.selected = true;
    ph.textContent = 'Bitte wählen…';
    teamEl.appendChild(ph);

    if(!fiberVal){
      teamEl.disabled = true;
      teamEl.options[0].textContent = 'Bitte zuerst Abteilung wählen…';
      return;
    }

    const teams = [
      {value:'1', label:'P1'},
      {value:'2', label:'P2'},
      {value:'3', label:'P3'},
      {value:'4', label:'P4'},
    ];
    for(const t of teams){
      const opt = document.createElement('option');
      opt.value = t.value;
      opt.textContent = t.label;
      teamEl.appendChild(opt);
    }
    teamEl.disabled = false;
  }

  function setError(msg){
    if(!msg){
      errEl.style.display = 'none';
      errEl.textContent = '';
      return;
    }
    errEl.style.display = 'block';
    errEl.textContent = msg;
  }

  function getParams(){
    const fiber = fiberEl.value;
    const team  = teamEl.value;
    const year  = yearEl.value;
    return {fiber, team, year};
  }


  async function trackEvent(ev){
    try{
      const {fiber, team, year} = getParams();
      if(!fiber || !team || !year) return;

      const url = `/track?event=${encodeURIComponent(ev)}&fiber=${encodeURIComponent(fiber)}&team=${encodeURIComponent(team)}&year=${encodeURIComponent(year)}`;

      if (navigator.sendBeacon) {
        const blob = new Blob([], { type: 'application/octet-stream' });
        navigator.sendBeacon(url, blob);
        return;
      }
      fetch(url, { method: 'POST', keepalive: true }).catch(()=>{});
    }catch(e){}
  }

  function isValidSelection(){
    const {fiber, team, year} = getParams();
    if(!fiber || !team || !year) return false;
    const y = Number(year);
    return Number.isFinite(y) && y >= startYear && y <= safeEndYear;
  }

  function updateButtons(){
    const ok = isValidSelection();
    btnGenerate.disabled = !ok;
    btnPrintV1.disabled  = !ok || !hasGenerated;
    btnPrintV2.disabled  = !ok || !hasGenerated;
  }

  setTeamOptionsForFiber('');
  updateButtons();
  loadGlobalCounter();

  fiberEl.addEventListener('change', () => {
    setTeamOptionsForFiber(fiberEl.value);
    setError('');
    outEl.style.display = 'none';
    updateButtons();
  });
  teamEl.addEventListener('change', () => { setError(''); updateButtons(); });
  yearEl.addEventListener('change', () => { setError(''); updateButtons(); });

  function openPrint(which){
    if(!isValidSelection()) return;
    const {fiber, team, year} = getParams();

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isStandalone = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) ||
                         (window.navigator && window.navigator.standalone === true);

    let url = `/${which}?fiber=${encodeURIComponent(fiber)}&team=${encodeURIComponent(team)}&year=${encodeURIComponent(year)}`;

    // iOS Homescreen/Web-App: force real download so user can print from Dateien/Share.
    if (isIOS && isStandalone){
      url += '&dl=1';
      location.href = url;
      return;
    }

    // Everywhere else (incl. Windows/Android PWA): open in a new window/tab so the app stays open.
    window.open(url, '_blank', 'noopener');
  }

  btnPrintV1.addEventListener('click', () => { trackEvent('pdfv1'); openPrint('pdfv1'); });
  btnPrintV2.addEventListener('click', () => { trackEvent('pdfv2'); openPrint('pdfv2'); });

  btnGenerate.addEventListener('click', async () => {
    setError('');
    outEl.style.display = 'none';
    linksEl.innerHTML = '';

    if(!isValidSelection()){
      setError(`Fehler: Jahr muss ${startYear} bis ${safeEndYear} sein und Abteilung/Team müssen gewählt sein.`);
      return;
    }

    const {fiber, team, year} = getParams();
    const genUrl = `/generate?fiber=${encodeURIComponent(fiber)}&team=${encodeURIComponent(team)}&year=${encodeURIComponent(year)}`;

    btnGenerate.disabled = true;
    btnGenerate.textContent = 'Generiere…';

    try{
      const res = await fetch(genUrl, {method:'GET'});
      if(!res.ok){
        const t = await res.text().catch(()=> '');
        throw new Error(t || `HTTP ${res.status}`);
      }

      const data = await res.json();

      const icsUrl = data.ics_url || `/ics?fiber=${fiber}&team=${team}&year=${year}`;
      const rawUrl = data.raw_url || icsUrl;
      const webcalUrl = data.webcal_url || (location.origin.replace('https://','webcal://') + icsUrl);

      const mkA = (href, text) => {
        const a = document.createElement('a');
        a.href = href;
        a.target = '_blank';
        a.rel = 'noopener';
        a.textContent = text;
        return a;
      };

      linksEl.appendChild(mkA(icsUrl, 'ICS (iOS/Android)'));
      linksEl.appendChild(mkA(rawUrl, 'RAW (ios/Android)'));
      linksEl.appendChild(mkA(webcalUrl, 'Kalender Abo (iOS/Android)'));

      const qrBase = 'https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=';
      qrIosImg.src = qrBase + encodeURIComponent(webcalUrl);
      urlIosEl.textContent = webcalUrl;

      qrAndImg.src = qrBase + encodeURIComponent(rawUrl);
      urlAndEl.textContent = rawUrl;

      outEl.style.display = 'block';

      /* ✅ HIER wird gezählt (nur bei Erfolg) */
      incrementGlobalCounter();

    
    hasGenerated = true;
    updateButtons();
}catch(e){
      setError('Fehler: ' + (e && e.message ? e.message : String(e)));
    }finally{
      btnGenerate.textContent = 'Generieren';
      updateButtons();
    }
  });

  // TRACK_ICS_CAPTURE: count ICS/RAW/WebCal usage (counts clicks)
  // Robust across relative/absolute URLs and iOS Safari quirks.
  document.addEventListener('click', (ev) => {
    try{
      const a = ev.target && ev.target.closest ? ev.target.closest('a') : null;
      if(!a) return;

      const hrefProp = a.href || '';
      const hrefAttr = a.getAttribute ? (a.getAttribute('href') || '') : '';
      const href = hrefProp || hrefAttr;

      // webcal:// subscription link
      if ((hrefAttr && hrefAttr.startsWith('webcal:')) || (hrefProp && hrefProp.startsWith('webcal:'))) {
        trackEvent('ics');
        return;
      }

      // Normal links (relative or absolute)
      try{
        const u = new URL(href, location.href);
        if (u.pathname === '/ics') {
          trackEvent('ics'); // +1 per click (ICS / RAW)
        }
      }catch(_){}
    }catch(e){}
  }, true);

})();

</script>


<script>
  // PWA Service Worker
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/sw.js").catch(() => {});
    });
  }

</script>

</body>
</html>