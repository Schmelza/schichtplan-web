<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Schichtkalender Generator</title>
  <style>
    :root{--bg:#fff;--fg:#111;--muted:#666;--border:#ddd;--blue:#0b63f6;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:32px;}
    h1{margin:0 0 18px 0;font-size:34px;text-align:center;}
    .card{max-width:980px;margin:0 auto;border:1px solid var(--border);border-radius:14px;padding:18px 18px 14px 18px;box-shadow:0 6px 20px rgba(0,0,0,.06);}
    .row{display:flex;gap:16px;flex-wrap:wrap;}
    .col{flex:1;min-width:240px;}
    label{display:block;font-weight:600;margin:8px 0 6px 0;}
    select,input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:16px;}
    button{width:100%;padding:12px 14px;border:0;border-radius:12px;background:var(--blue);color:#fff;font-weight:700;font-size:16px;cursor:pointer;margin-top:14px;}
    button:disabled{opacity:.55;cursor:not-allowed;}
    .muted{color:var(--muted);font-size:13px;margin-top:8px;}
    .error{color:#b00020;font-weight:700;margin-top:10px;}
    .ok{color:#0a7b2a;font-weight:700;margin-top:10px;}
    .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;}
    .actions a{flex:1;min-width:240px;text-align:center;text-decoration:none;padding:10px 12px;border:1px solid var(--border);border-radius:12px;font-weight:700;color:#111;background:#fafafa;}
    .actions a:hover{background:#f2f2f2;}
    .qrwrap{display:flex;gap:16px;flex-wrap:wrap;margin-top:14px;}
    .qrbox{flex:1;min-width:280px;border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;background:#fff;}
    .qrbox h3{margin:6px 0 10px 0;font-size:16px;}
    .qrbox img{width:240px;height:240px;image-rendering:auto;border:1px solid var(--border);border-radius:10px;background:#fff;}
    .small{font-size:12px;color:var(--muted);word-break:break-all;margin-top:8px;}
    .hr{height:1px;background:var(--border);margin:18px 0;}
  </style>
</head>
<body>
  <h1>Schichtkalender (ICS) – Web Generator</h1>

  <div class="card">
    <div class="row">
      <div class="col">
        <label for="fiber">Fiber</label>
        <select id="fiber">
          <option value="2" selected>Fiber 2</option>
          <option value="1">Fiber 1</option>
        </select>
      </div>

      <div class="col">
        <label for="team">Team</label>
        <select id="team">
          <option value="1">Team 1 (P1)</option>
          <option value="2" selected>Team 2 (P2)</option>
          <option value="3">Team 3 (P3)</option>
          <option value="4">Team 4 (P4)</option>
        </select>
      </div>

      <div class="col">
        <label for="year">Jahr</label>
        <input id="year" type="number" inputmode="numeric" />
        <div class="muted" id="yearHint"></div>
      </div>
    </div>

    <button id="btnGen">Generieren</button>

    <div id="msg" class="muted"></div>

    <div class="hr"></div>

    <div id="links" style="display:none;">
      <div class="actions">
        <a id="dlIcs" href="#" target="_blank" rel="noopener">ICS öffnen / downloaden</a>
        <a id="printV1" href="#" target="_blank" rel="noopener">Druck V1 (wie Excel)</a>
        <a id="printV2" href="#" target="_blank" rel="noopener">Druck V2 (wie Excel)</a>
      </div>

      <div class="qrwrap">
        <div class="qrbox">
          <h3>iOS (webcal Abo)</h3>
          <img id="qrIos" alt="QR iOS" />
          <div class="small" id="iosTxt"></div>
        </div>
        <div class="qrbox">
          <h3>Android (HTTPS Import/Download)</h3>
          <img id="qrAnd" alt="QR Android" />
          <div class="small" id="andTxt"></div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // VBA: minYear = 2026; maxYear = Year(Date)+4
  const MIN_YEAR = 2026;
  const now = new Date();
  const MAX_YEAR = now.getFullYear() + 4;

  $("year").value = now.getFullYear();
  $("yearHint").textContent = `Erlaubt: ${MIN_YEAR} bis ${MAX_YEAR}`;

  function encodeQR(url){
    return "https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=" + encodeURIComponent(url);
  }

  function buildUrls(fiber, team, year){
    const origin = location.origin;

    const icsHttps = `${origin}/ics?fiber=${fiber}&team=${team}&year=${year}`;
    const webcal = `webcal://${location.host}/ics?fiber=${fiber}&team=${team}&year=${year}`;

    const print1 = `${origin}/print?v=1&fiber=${fiber}&team=${team}&year=${year}`;
    const print2 = `${origin}/print?v=2&fiber=${fiber}&team=${team}&year=${year}`;

    return { icsHttps, webcal, print1, print2 };
  }

  function validateYear(y){
    if (!Number.isFinite(y)) return `Fehler: year muss eine Zahl sein`;
    if (y < MIN_YEAR || y > MAX_YEAR) return `Fehler: year muss ${MIN_YEAR} bis ${MAX_YEAR} sein`;
    return "";
  }

  $("btnGen").addEventListener("click", async () => {
    const fiber = parseInt($("fiber").value, 10);
    const team = parseInt($("team").value, 10);
    const year = parseInt($("year").value, 10);

    const err = validateYear(year);
    if (err){
      $("msg").className = "error";
      $("msg").textContent = err;
      $("links").style.display = "none";
      return;
    }

    $("btnGen").disabled = true;
    $("msg").className = "muted";
    $("msg").textContent = "Generiere Links …";

    try{
      // optional: ping generate endpoint (gibt JSON zurück)
      const r = await fetch(`/generate?fiber=${fiber}&team=${team}&year=${year}`, { cache:"no-store" });
      if(!r.ok){
        const t = await r.text();
        throw new Error(t || `HTTP ${r.status}`);
      }
      const data = await r.json();

      const urls = buildUrls(fiber, team, year);

      // Links
      $("dlIcs").href = urls.icsHttps;
      $("printV1").href = urls.print1;
      $("printV2").href = urls.print2;

      // QR
      $("qrIos").src = encodeQR(urls.webcal);
      $("qrAnd").src = encodeQR(urls.icsHttps);

      $("iosTxt").textContent = urls.webcal;
      $("andTxt").textContent = urls.icsHttps;

      $("links").style.display = "block";
      $("msg").className = "ok";
      $("msg").textContent = "OK – ICS / Druck / QR bereit.";
    }catch(e){
      $("links").style.display = "none";
      $("msg").className = "error";
      $("msg").textContent = "Fehler: " + (e?.message || e);
    }finally{
      $("btnGen").disabled = false;
    }
  });
})();
</script>
</body>
</html>
