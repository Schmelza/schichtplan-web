<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Druck V1</title>
  <style>
    @page { size: A4 landscape; margin: 10mm; }
    body{font-family:Calibri,Arial,sans-serif;margin:0;color:#111}
    h1{margin:0;text-align:center;font-size:24px}
    .sub{margin-top:4px;text-align:center;font-size:12px;color:#333}
    .topright{position:absolute;top:10mm;right:12mm;font-size:12px;text-align:left;white-space:pre-line}
    .wrap{padding:10mm;position:relative}
    table{border-collapse:collapse;width:100%;table-layout:fixed;margin-top:14px}
    th,td{border:1px solid #000;font-size:11px;padding:2px 3px;text-align:center}
    th{background:#f2f2f2}
    .mname{font-weight:700;width:70px;background:#fff}
    .rowlbl{width:72px;font-weight:700;background:#fff}
    .legend{margin-top:10px;display:flex;gap:10px;justify-content:center;font-size:12px}
    .box{border:1px solid #000;padding:4px 10px}
    .F{background:#fff200}
    .S{background:#ff0000;color:#000}
    .N{background:#00b0f0}
    .FEI{background:#f4cccc}
    .FER{background:#cfe2f3}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topright" id="phones"></div>
    <h1 id="title"></h1>
    <div class="sub">Printed by: Johannes Trippen©</div>

    <div id="tbl"></div>

    <div class="legend">
      <div class="box FEI">Feiertag</div>
      <div class="box FER">Ferien</div>
      <div class="box F">F = Früh</div>
      <div class="box S">S = Spät</div>
      <div class="box N">N = Nacht</div>
    </div>
  </div>

<script>
  const monthNames = ["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"];
  const wdShort = ["So","Mo","Di","Mi","Do","Fr","Sa"];

  const PHONES = {
    "1": { office:"06542/802277", mobile:"06542/802508", lead:"06542/802594" },
    "2": { office:"06542/802273", mobile:"06542/802505", lead:"06542/802530" }
  };

  function qs() {
    const u = new URL(location.href);
    return {
      fiber: Number(u.searchParams.get("fiber")||2),
      team:  Number(u.searchParams.get("team")||2),
      year:  Number(u.searchParams.get("year")||new Date().getFullYear())
    };
  }
  function baseUrl(){ return location.origin; }

  async function getData(p){
    const url = `${baseUrl()}/generate?fiber=${p.fiber}&team=${p.team}&year=${p.year}&mode=data`;
    const res = await fetch(url);
    if(!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  function cellClass(d){
    if (d.isFeiertag) return "FEI";
    if (d.isFerien) return "FER";
    return d.shift; // F/S/N
  }

  function render(p, data){
    document.getElementById("title").textContent = `Schichtplan ${p.year} – Fiber ${p.fiber} – Team P${p.team} (V1)`;
    const ph = PHONES[String(p.fiber)] || PHONES["2"];
    document.getElementById("phones").textContent =
      `Büro: ${ph.office}\nMobil: ${ph.mobile}\nTeamleiter: ${ph.lead}`;

    // Pro Monat: 3 Zeilen: Wochentag / Tag / Schicht (wie Excel)
    let html = `<table>`;
    for (let m=0;m<12;m++){
      const days = data.months[m].days;
      const daysInMonth = days.length;

      // Header row for the month
      html += `<tr>
        <td class="mname" rowspan="3">${monthNames[m]}</td>
        <td class="rowlbl">Wochentag</td>`;

      for (let d=1; d<=31; d++){
        if (d<=daysInMonth){
          const info = days[d-1];
          html += `<td>${wdShort[info.weekday]}</td>`;
        } else {
          html += `<td></td>`;
        }
      }
      html += `</tr>`;

      // Day numbers
      html += `<tr><td class="rowlbl">Tag</td>`;
      for (let d=1; d<=31; d++){
        html += (d<=daysInMonth) ? `<td>${d}</td>` : `<td></td>`;
      }
      html += `</tr>`;

      // Shifts (colored)
      html += `<tr><td class="rowlbl">Schicht</td>`;
      for (let d=1; d<=31; d++){
        if (d<=daysInMonth){
          const info = days[d-1];
          const cls = cellClass(info);
          html += `<td class="${cls}"><b>${info.shift}</b></td>`;
        } else {
          html += `<td></td>`;
        }
      }
      html += `</tr>`;
    }
    html += `</table>`;
    document.getElementById("tbl").innerHTML = html;

    setTimeout(() => window.print(), 300);
  }

  (async () => {
    const p = qs();
    const data = await getData(p);
    render(p, data);
  })().catch(e => {
    document.body.innerHTML = `<pre style="padding:16px;color:#b00020;font-weight:700">Fehler: ${e.message}</pre>`;
  });
</script>
</body>
</html>
